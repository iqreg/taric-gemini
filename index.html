<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>TARIC Bildklassifikation (Gemini)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-panel: #0b1220;
      --bg-panel-alt: #020617;
      --border: #1f2937;
      --accent: #2563eb;
      --accent-soft: rgba(37,99,235,0.15);
      --accent-strong: rgba(37,99,235,0.5);
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --error: #ef4444;
      --success: #22c55e;
      --warning: #facc15;
      --radius: 14px;
      --shadow: 0 20px 45px rgba(15,23,42,0.9);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 16px 12px 32px;
    }

    .app {
      width: 100%;
      max-width: 520px;
      background: linear-gradient(145deg, #020617 0, #020617 40%, #020617 100%);
      border-radius: 24px;
      border: 1px solid #1f2937;
      box-shadow: var(--shadow);
      padding: 14px 14px 20px;
      overflow: hidden;
    }

    header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 4px 4px 10px;
      border-bottom: 1px solid rgba(148,163,184,0.24);
      margin-bottom: 12px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    h1 {
      font-size: 20px;
      line-height: 1.2;
      margin: 0;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    h1 .icon {
      font-size: 18px;
    }

    .subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: radial-gradient(circle at top, #0f172a 0, #020617 90%);
    }

    .pill span {
      font-weight: 600;
    }

    .pill-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(56,189,248,0.18);
      border: 1px solid rgba(56,189,248,0.7);
      color: #e0f2fe;
    }

    .nav-links {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .nav-link {
      text-decoration: none;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: radial-gradient(circle at top, #020617, #020617 95%);
      color: #e5e7eb;
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.08s ease;
    }

    .nav-link span.icon {
      font-size: 13px;
    }

    .nav-link.active {
      background: radial-gradient(circle at top, #1d4ed8, #020617);
      border-color: rgba(129,140,248,0.9);
    }

    .nav-link:hover {
      transform: translateY(-1px);
      border-color: rgba(191,219,254,0.7);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 80%);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 12px 12px 14px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left,
          rgba(56,189,248,0.12) 0,
          transparent 60%);
      opacity: 0.7;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.icon {
      font-size: 14px;
    }

    .card-step {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin: 4px 0 10px;
      line-height: 1.5;
    }

    .file-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    input[type="file"] {
      font-size: 13px;
      color: var(--text);
    }

    .filename {
      font-size: 12px;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .preview-frame {
      border-radius: 18px;
      border: 1px dashed rgba(148,163,184,0.5);
      padding: 6px;
      background: radial-gradient(circle at top,
          rgba(148,163,184,0.18) 0,
          #020617 55%);
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 12px;
      min-height: 220px;
    }

    .preview-frame img {
      max-width: 100%;
      border-radius: 14px;
      display: block;
    }

    .btn-primary {
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      color: #eff6ff;
      background: radial-gradient(circle at top,
          #38bdf8 0,
          #2563eb 40%,
          #1d4ed8 100%);
      box-shadow: 0 16px 30px rgba(37,99,235,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 10px 18px rgba(37,99,235,0.7);
    }

    .btn-primary[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .btn-primary span.emoji {
      font-size: 17px;
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(34,197,94,0.1);
      border: 1px solid rgba(34,197,94,0.9);
      color: #bbf7d0;
    }

    .status-badge.error {
      background: rgba(239,68,68,0.12);
      border-color: rgba(239,68,68,0.9);
      color: #fecaca;
    }

    .status-text {
      font-size: 11px;
      color: var(--text-muted);
      flex: 1;
    }

    .result-title {
      font-size: 15px;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .result-title .icon {
      font-size: 16px;
    }

    .result-main {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .code-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .code-pill-label {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .code-pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top, #020617 0, #020617 85%);
      font-size: 15px;
      letter-spacing: 0.16em;
      text-align: center;
      flex: 1;
    }

    .confidence-wrap {
      text-align: right;
      min-width: 140px;
    }

    .confidence-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .confidence-value {
      font-size: 14px;
      font-weight: 600;
      margin-top: 2px;
    }

    .confidence-badge {
      font-size: 11px;
      margin-top: 2px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
    }

    .confidence-badge.low {
      border-color: rgba(248,113,113,0.9);
      background: rgba(248,113,113,0.15);
      color: #fecaca;
    }

    .confidence-badge.medium {
      border-color: rgba(250,204,21,0.9);
      background: rgba(250,204,21,0.15);
      color: #fef9c3;
    }

    .confidence-badge.high {
      border-color: rgba(34,197,94,0.9);
      background: rgba(22,163,74,0.15);
      color: #bbf7d0;
    }

    .confidence-bar {
      margin-top: 4px;
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      overflow: hidden;
      border: 1px solid rgba(30,64,175,0.9);
    }

    .confidence-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,
          #f97316 0,
          #facc15 35%,
          #22c55e 100%);
      transition: width 0.25s ease-out;
    }

    .tags-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .tag {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tag span.icon {
      font-size: 12px;
    }

    .section-label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .reason {
      font-size: 13px;
      line-height: 1.55;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .alt-list {
      margin: 0;
      padding-left: 18px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .alt-list li + li {
      margin-top: 4px;
    }

    .feedback-block {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(55,65,81,0.9);
    }

    .feedback-title {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 4px;
    }

    .feedback-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin: 0 0 8px;
    }

    .feedback-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-feedback {
      flex: 1;
      min-width: 120px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 7px 10px;
      font-size: 13px;
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.12s ease, transform 0.06s ease;
    }

    .btn-feedback:active {
      transform: translateY(1px);
    }

    .btn-feedback.positive {
      border-color: rgba(34,197,94,0.8);
    }

    .btn-feedback.negative {
      border-color: rgba(239,68,68,0.8);
    }

    .btn-feedback.saved {
      background: rgba(34,197,94,0.15);
    }

    .technical-hint {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .technical-hint code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(15,23,42,0.95);
      padding: 2px 5px;
      border-radius: 5px;
      border: 1px solid rgba(55,65,81,0.9);
    }

    .meta-result {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      body {
        padding: 8px 6px 24px;
      }

      .app {
        border-radius: 18px;
        padding: 10px 10px 16px;
      }

      header {
        padding: 4px 2px 8px;
        flex-direction: column;
      }

      .header-right {
        align-items: flex-start;
      }

      h1 {
        font-size: 18px;
      }

      .preview-frame {
        min-height: 200px;
      }

      .code-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .confidence-wrap {
        width: 100%;
        text-align: left;
      }

      .confidence-bar {
        max-width: 220px;
      }

      .feedback-buttons {
        flex-direction: row;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1><span class="icon">üì∑</span>TARIC Klassifikation per Foto</h1>
        <p class="subtitle">
          Foto hochladen ‚Üí Modell ermittelt den wahrscheinlichsten TARIC-Code inkl. Begr√ºndung.
        </p>
      </div>
      <div class="header-right">
        <div class="pill">
          <span>Gemini&nbsp;2.5</span>
          <span class="pill-badge">CV&nbsp;+ TARIC</span>
        </div>
        <div class="nav-links">
          <a href="index.html" class="nav-link active">
            <span class="icon">üì∑</span><span>Klassifikation</span>
          </a>
          <a href="evaluation.html" class="nav-link">
            <span class="icon">üß™</span><span>Evaluation</span>
          </a>
        </div>
      </div>
    </header>

    <main>
      <!-- Bild-Upload -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üñºÔ∏è</span>
              <span>Bild-Upload</span>
            </div>
            <div class="card-step">Schritt 1</div>
          </div>

          <p class="hint">
            Foto aufnehmen oder ein Bild aus der Galerie w√§hlen. Das Bild wird nur an dein lokales Backend gesendet, keine Cloud-Speicherung.
          </p>

          <div class="file-row">
            <input type="file" id="file-input" accept="image/*" />
            <div class="filename" id="file-name">Keine Datei ausgew√§hlt</div>
          </div>

          <div class="preview-frame">
            <img id="preview-image" alt="Bildvorschau" style="display:none;" />
          </div>

          <button class="btn-primary" id="classify-btn" disabled>
            <span class="emoji">üöÄ</span>
            <span>Bild klassifizieren</span>
          </button>

          <div class="status-row" id="status-row" style="display:none;">
            <div class="status-badge" id="status-badge">
              <span>‚úî</span>
              <span id="status-label">Ergebnis bereit</span>
            </div>
            <div class="status-text" id="status-text"></div>
          </div>

          <p class="technical-hint">
            Hinweis: Backend muss auf Port <code>8000</code> laufen, diese Seite auf
            <code>8080</code> (z. B. <code>python3 -m http.server 8080 --bind 0.0.0.0</code>).
          </p>
        </div>
      </section>

      <!-- Klassifikation & Feedback -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìä</span>
              <span>Klassifikation &amp; Feedback</span>
            </div>
            <div class="card-step">Schritt 2</div>
          </div>

          <h2 class="result-title">
            <span class="icon">üéØ</span>
            <span>Ergebnis</span>
          </h2>

          <div class="result-main">
            <div class="code-row">
              <div style="flex: 1;">
                <div class="code-pill-label">TARIC</div>
                <div class="code-pill" id="taric-code">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
              </div>
              <div class="confidence-wrap">
                <div class="confidence-label">Confidence</div>
                <div class="confidence-value" id="confidence-value">‚Äì</div>
                <div class="confidence-badge" id="confidence-badge">
                  <span class="icon">üü¶</span>
                  <span id="confidence-label">keine Bewertung</span>
                </div>
                <div class="confidence-bar">
                  <div class="confidence-bar-fill" id="confidence-bar"></div>
                </div>
              </div>
            </div>

            <div class="tags-row">
              <div class="tag">
                <span class="icon">üá™üá∫</span>
                <strong>CN-Code</strong>
                <span id="cn-code" style="margin-left:6px;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
              </div>
              <div class="tag">
                <span class="icon">üìë</span>
                <strong>HS-Kapitel</strong>
                <span id="hs-chapter" style="margin-left:6px;">‚îÄ‚îÄ</span>
              </div>
            </div>

            <div>
              <div class="section-label">Begr√ºndung:</div>
              <p class="reason" id="reason-text">
                Noch keine Auswertung durchgef√ºhrt.
              </p>
            </div>

            <div>
              <div class="section-label">Alternative Codes (falls vorhanden):</div>
              <ul class="alt-list" id="alt-list">
                <li>Keine Alternativcodes angegeben.</li>
              </ul>
            </div>

            <div class="meta-result" id="meta-result">
              ID: ‚Äì ¬∑ Datei: ‚Äì 
            </div>
          </div>

          <div class="feedback-block">
            <p class="feedback-title">Passt der vorgeschlagene TARIC-Code?</p>
            <p class="feedback-sub">
              Dein Feedback hilft, die Auswertung zu verbessern (wird lokal im Browser gespeichert).
            </p>
            <div class="feedback-buttons">
              <button class="btn-feedback positive" id="btn-ok">
                <span>üëç</span><span>Ja, passt</span>
              </button>
              <button class="btn-feedback negative" id="btn-no">
                <span>üëé</span><span>Nein, ist falsch</span>
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const fileInput = document.getElementById("file-input");
    const fileNameEl = document.getElementById("file-name");
    const previewImg = document.getElementById("preview-image");
    const classifyBtn = document.getElementById("classify-btn");

    const statusRow = document.getElementById("status-row");
    const statusBadge = document.getElementById("status-badge");
    const statusLabel = document.getElementById("status-label");
    const statusText = document.getElementById("status-text");

    const taricEl = document.getElementById("taric-code");
    const cnEl = document.getElementById("cn-code");
    const hsEl = document.getElementById("hs-chapter");
    const confValEl = document.getElementById("confidence-value");
    const confBarEl = document.getElementById("confidence-bar");
    const confBadgeEl = document.getElementById("confidence-badge");
    const confLabelEl = document.getElementById("confidence-label");
    const reasonEl = document.getElementById("reason-text");
    const altListEl = document.getElementById("alt-list");
    const metaResultEl = document.getElementById("meta-result");

    const btnOk = document.getElementById("btn-ok");
    const btnNo = document.getElementById("btn-no");

    let lastResult = null;

    function backendUrl() {
      const host = window.location.hostname || "localhost";
      const protocol = window.location.protocol || "http:";
      return `${protocol}//${host}:8000/classify`;
    }

    fileInput.addEventListener("change", () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) {
        fileNameEl.textContent = "Keine Datei ausgew√§hlt";
        previewImg.style.display = "none";
        classifyBtn.disabled = true;
        return;
      }

      fileNameEl.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewImg.style.display = "block";
      };
      reader.readAsDataURL(file);
      classifyBtn.disabled = false;
    });

    function setStatus(type, message, hint) {
      if (!message && !hint) {
        statusRow.style.display = "none";
        return;
      }
      statusRow.style.display = "flex";
      const isError = type === "error";
      statusBadge.classList.toggle("error", isError);
      statusLabel.textContent = isError ? "Fehler" : "Status";
      statusText.textContent = hint || message || "";
    }

    async function classifyImage() {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      classifyBtn.disabled = true;
      classifyBtn.innerHTML = "<span class='emoji'>‚è≥</span><span>Analyse l√§uft ‚Ä¶</span>";
      setStatus("info", null, "Bild wird an das Backend gesendet ‚Ä¶");

      try {
        const formData = new FormData();
        formData.append("file", file);

        const response = await fetch(backendUrl(), {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          let detail = `HTTP ${response.status}`;
          try {
            const errJson = await response.json();
            if (errJson && errJson.error) {
              detail = errJson.error;
            }
          } catch (_) { /* ignorieren */ }

          setStatus("error", null, `Fehler bei /classify: ${detail}`);
          classifyBtn.disabled = false;
          classifyBtn.innerHTML = "<span class='emoji'>üöÄ</span><span>Bild klassifizieren</span>";
          return;
        }

        let data = await response.json();

        // Falls das Backend ausnahmsweise einen String liefern w√ºrde
        if (typeof data === "string") {
          data = JSON.parse(data);
        }

        lastResult = data;
        renderResult(data);
        setStatus("success", null, "Ergebnis erfolgreich erhalten.");
      } catch (err) {
        console.error(err);
        setStatus("error", null, "Backend nicht erreichbar oder Antwort ung√ºltig.");
      } finally {
        classifyBtn.disabled = false;
        classifyBtn.innerHTML = "<span class='emoji'>üöÄ</span><span>Bild klassifizieren</span>";
      }
    }

    function updateConfidenceUI(conf) {
      if (conf === null || Number.isNaN(conf)) {
        confValEl.textContent = "‚Äì";
        confBarEl.style.width = "0%";
        confBadgeEl.classList.remove("low", "medium", "high");
        confLabelEl.textContent = "keine Bewertung";
        return;
      }

      const pct = Math.round(conf * 100);
      confValEl.textContent = pct + " %";
      confBarEl.style.width = Math.min(100, Math.max(0, pct)) + "%";

      confBadgeEl.classList.remove("low", "medium", "high");

      if (pct < 50) {
        confBadgeEl.classList.add("low");
        confLabelEl.textContent = "niedrig";
      } else if (pct < 80) {
        confBadgeEl.classList.add("medium");
        confLabelEl.textContent = "mittel";
      } else {
        confBadgeEl.classList.add("high");
        confLabelEl.textContent = "hoch";
      }
    }

    function renderResult(data) {
      const taric = data.taric_code || "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
      const cn = data.cn_code || "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
      const hs = data.hs_chapter || "‚îÄ‚îÄ";
      const conf = typeof data.confidence === "number" ? data.confidence : null;
      const reason = data.short_reason || "Keine Begr√ºndung vorhanden.";

      taricEl.textContent = taric;
      cnEl.textContent = cn;
      hsEl.textContent = (hs ?? "").toString().padStart(2, "0");

      updateConfidenceUI(conf);

      reasonEl.textContent = reason;

      altListEl.innerHTML = "";
      if (Array.isArray(data.possible_alternatives) && data.possible_alternatives.length > 0) {
        data.possible_alternatives.forEach((alt) => {
          const li = document.createElement("li");
          const code = alt.taric_code || "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
          const r = alt.short_reason || "Keine Begr√ºndung.";
          li.textContent = `${code}: ${r}`;
          altListEl.appendChild(li);
        });
      } else {
        const li = document.createElement("li");
        li.textContent = "Keine Alternativcodes angegeben.";
        altListEl.appendChild(li);
      }

      const id = data.id ?? "‚Äì";
      const fn = data.filename ?? "‚Äì";
      metaResultEl.textContent = `ID: ${id} ¬∑ Datei: ${fn}`;

      btnOk.classList.remove("saved");
      btnNo.classList.remove("saved");
    }

    function storeFeedback(isCorrect) {
      if (!lastResult) return;
      const entry = {
        timestamp: new Date().toISOString(),
        id: lastResult.id ?? null,
        filename: lastResult.filename ?? null,
        taric_code: lastResult.taric_code || null,
        cn_code: lastResult.cn_code || null,
        hs_chapter: lastResult.hs_chapter || null,
        confidence: lastResult.confidence ?? null,
        short_reason: lastResult.short_reason || null,
        possible_alternatives: lastResult.possible_alternatives || [],
        feedback: isCorrect ? "ok" : "wrong",
      };

      let all = [];
      try {
        const raw = localStorage.getItem("taric_feedback");
        if (raw) all = JSON.parse(raw);
      } catch {
        all = [];
      }
      all.push(entry);
      localStorage.setItem("taric_feedback", JSON.stringify(all));

      if (isCorrect) {
        btnOk.classList.add("saved");
        btnNo.classList.remove("saved");
      } else {
        btnNo.classList.add("saved");
        btnOk.classList.remove("saved");
      }
    }

    classifyBtn.addEventListener("click", classifyImage);
    btnOk.addEventListener("click", () => storeFeedback(true));
    btnNo.addEventListener("click", () => storeFeedback(false));
  </script>
</body>
</html>
