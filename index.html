<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>TARIC Bildklassifikation (Gemini)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-panel: #111827;
      --bg-panel-alt: #020617;
      --border: #1f2937;
      --accent: #2563eb;
      --accent-soft: rgba(37,99,235,0.12);
      --accent-strong: rgba(37,99,235,0.4);
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --error: #ef4444;
      --success: #22c55e;
      --radius: 14px;
      --shadow: 0 18px 45px rgba(15,23,42,0.75);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.2rem;
      background: radial-gradient(circle at top, #1f2937 0, #020617 52%, #000 100%);
      color: var(--text);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 1.2rem;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0 0 0.25rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    h1 span.badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid var(--accent-strong);
      color: #bfdbfe;
    }

    header p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    main {
      display: grid;
      gap: 1rem;
    }

    @media (min-width: 900px) {
      main {
        grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
        align-items: flex-start;
      }
    }

    .panel {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: linear-gradient(145deg, var(--bg-panel), var(--bg-panel-alt));
      box-shadow: var(--shadow);
      padding: 1rem 1.1rem;
    }

    .panel h2 {
      font-size: 1rem;
      margin: 0 0 0.7rem 0;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .panel h2 small {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    label {
      font-size: 0.85rem;
      font-weight: 500;
    }

    input[type="file"] {
      margin-top: 0.35rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .preview-wrapper {
      margin-top: 0.7rem;
      border-radius: 12px;
      border: 1px dashed #374151;
      background: radial-gradient(circle at top left, rgba(37,99,235,0.15), transparent 60%);
      padding: 0.6rem;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 160px;
    }

    #preview {
      max-width: 100%;
      max-height: 260px;
      border-radius: 10px;
      display: none;
      object-fit: contain;
      box-shadow: 0 10px 30px rgba(0,0,0,0.55);
    }

    .preview-placeholder {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .actions {
      margin-top: 0.8rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
      justify-content: space-between;
    }

    .btn {
      padding: 0.55rem 1.2rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: radial-gradient(circle at top, #1d4ed8, #1d2438);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, border-color 0.12s ease;
      box-shadow: 0 12px 32px rgba(37,99,235,0.4);
    }

    .btn span.icon {
      font-size: 1em;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(37,99,235,0.55);
      border-color: rgba(191,219,254,0.9);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 8px 25px rgba(15,23,42,0.8);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      background: #111827;
      border-color: #1f2937;
    }

    .status-line {
      font-size: 0.83rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.75rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15,23,42,0.7);
    }

    .status-pill.success {
      border-color: rgba(34,197,94,0.55);
      background: rgba(22,163,74,0.15);
      color: #bbf7d0;
    }

    .status-pill.error {
      border-color: rgba(239,68,68,0.55);
      background: rgba(239,68,68,0.12);
      color: #fecaca;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(148,163,184,0.4);
      border-top-color: #93c5fd;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-text {
      margin-top: 0.25rem;
      white-space: pre-line;
    }

    /* Ergebnis-Panel */

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    .taric-main {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1.25rem;
      letter-spacing: 0.15em;
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.6);
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .taric-main-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    .confidence {
      margin-top: 0.35rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .confidence-bar {
      margin-top: 0.25rem;
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      overflow: hidden;
      border: 1px solid rgba(31,41,55,0.9);
    }

    .confidence-bar-inner {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #eab308);
      width: 0%;
      transition: width 0.25s ease-out;
    }

    .codes-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }

    .code-pill {
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15,23,42,0.85);
      color: var(--text-muted);
    }

    .code-pill strong {
      color: #e5e7eb;
      margin-right: 0.2rem;
    }

    .short-reason {
      margin-top: 0.6rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .short-reason strong {
      color: #e5e7eb;
    }

    .alternatives {
      margin-top: 0.8rem;
      font-size: 0.8rem;
    }

    .alternatives h3 {
      margin: 0 0 0.3rem 0;
      font-size: 0.85rem;
      color: #d1d5db;
    }

    .alt-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .alt-item {
      padding: 0.35rem 0.5rem;
      border-radius: 10px;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(31,41,55,0.85);
    }

    .alt-item-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      letter-spacing: 0.14em;
      color: #bfdbfe;
    }

    .alt-item-reason {
      margin-top: 0.2rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .no-result {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Feedback */

    .feedback-section {
      margin-top: 0.9rem;
      padding-top: 0.8rem;
      border-top: 1px dashed #1f2937;
    }

    .feedback-options {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.35rem;
    }

    .feedback-button {
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
    }

    .feedback-button span.icon {
      font-size: 1em;
    }

    .feedback-button.active.yes {
      background: rgba(34,197,94,0.15);
      border-color: rgba(34,197,94,0.7);
      color: #bbf7d0;
      transform: translateY(-1px);
    }

    .feedback-button.active.no {
      background: rgba(239,68,68,0.16);
      border-color: rgba(239,68,68,0.7);
      color: #fecaca;
      transform: translateY(-1px);
    }

    .feedback-extra {
      margin-top: 0.6rem;
      display: none;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.8rem;
    }

    .feedback-extra.visible {
      display: flex;
    }

    .feedback-extra input,
    .feedback-extra textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 0.3rem 0.4rem;
      background: rgba(15,23,42,0.8);
      color: #e5e7eb;
      font-size: 0.8rem;
      resize: vertical;
      min-height: 60px;
    }

    .feedback-save {
      align-self: flex-start;
      padding: 0.3rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: radial-gradient(circle at top, #16a34a, #14532d);
      color: #ecfdf5;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      box-shadow: 0 10px 30px rgba(22,163,74,0.45);
    }

    .feedback-save:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 35px rgba(22,163,74,0.65);
    }

    .feedback-save:active {
      transform: translateY(0);
      box-shadow: 0 6px 20px rgba(15,23,42,0.8);
    }

    .feedback-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .feedback-status {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Raw JSON */

    .raw-section {
      margin-top: 0.7rem;
      font-size: 0.78rem;
    }

    .toggle-raw {
      border: none;
      background: transparent;
      color: #93c5fd;
      cursor: pointer;
      padding: 0;
      font-size: 0.78rem;
      text-decoration: underline;
    }

    #resultRaw {
      margin-top: 0.4rem;
      white-space: pre;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      max-height: 220px;
      overflow: auto;
      background: rgba(15,23,42,0.9);
      border-radius: 10px;
      padding: 0.45rem 0.6rem;
      border: 1px solid #1f2937;
      display: none;
    }

    /* kleine Helfer */

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.35rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>
        TARIC Klassifikation per Foto
        <span class="badge">Gemini 2.5</span>
      </h1>
      <p>
        Foto hochladen ‚Üí Modell ermittelt den wahrscheinlichsten TARIC-Code inkl. Begr√ºndung.
      </p>
    </header>

    <main>
      <!-- Linke Spalte: Upload / Status -->
      <section class="panel">
        <h2>
          Bild-Upload
          <small>Schritt 1</small>
        </h2>

        <label for="fileInput">Foto aufnehmen oder aus Galerie ausw√§hlen</label><br />
        <input
          id="fileInput"
          type="file"
          accept="image/*"
          capture="environment"
        />

        <div class="preview-wrapper">
          <img id="preview" alt="Bildvorschau" />
          <div id="previewPlaceholder" class="preview-placeholder">
            Noch kein Bild ausgew√§hlt.<br />
            Nutze oben ‚ÄûFoto aufnehmen / w√§hlen‚Äú.
          </div>
        </div>

        <div class="actions">
          <button id="sendBtn" class="btn" disabled>
            <span class="icon">üöÄ</span>
            <span>Bild klassifizieren</span>
          </button>
          <div class="status-line">
            <div id="statusPill" class="status-pill">
              <span id="statusPillIcon">‚è∏</span>
              <span id="statusPillText">Warte auf Bild</span>
            </div>
          </div>
        </div>

        <div class="status-text" id="status"></div>
        <div class="hint">
          Hinweis: Backend muss auf Port 8000 laufen, diese Seite auf 8080
          (z. B. <code>python3 -m http.server 8080 --bind 0.0.0.0</code>).
        </div>
      </section>

      <!-- Rechte Spalte: Ergebnis / Feedback -->
      <section class="panel">
        <h2>
          Klassifikation & Feedback
          <small>Schritt 2</small>
        </h2>

        <div id="resultContainer">
          <div class="no-result">
            Noch kein Ergebnis. Sende ein Bild, um den TARIC-Code zu ermitteln.
          </div>
        </div>

        <div class="feedback-section" id="feedbackSection" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
            <div>
              <strong>Passt der vorgeschlagene TARIC-Code?</strong><br />
              <span class="feedback-hint">
                Dein Feedback hilft, die Auswertung zu verbessern (wird lokal gespeichert).
              </span>
            </div>
          </div>

          <div class="feedback-options">
            <button id="fbYes" class="feedback-button yes">
              <span class="icon">üëç</span>
              <span>Ja, passt</span>
            </button>
            <button id="fbNo" class="feedback-button no">
              <span class="icon">üëé</span>
              <span>Nein, ist falsch</span>
            </button>
          </div>

          <div class="feedback-extra" id="feedbackExtra">
            <div>
              <label for="fbCorrectTaric">Korrekte TARIC-Nummer (falls bekannt)</label>
              <input id="fbCorrectTaric" type="text" placeholder="z. B. 9018908500" />
            </div>
            <div>
              <label for="fbComment">Kurzkommentar (z. B. Art der Ware, Fehlerbeschreibung)</label>
              <textarea id="fbComment" placeholder="Warum ist der Vorschlag falsch? Was w√§re korrekt?"></textarea>
            </div>
            <button id="fbSave" class="feedback-save">
              <span class="icon">üíæ</span>
              <span>Feedback lokal speichern</span>
            </button>
            <div id="fbStatus" class="feedback-status"></div>
          </div>
        </div>

        <div class="raw-section">
          <button type="button" class="toggle-raw" id="toggleRawBtn">
            Rohes JSON anzeigen
          </button>
          <div id="resultRaw"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ============================================================
    // Backend-URL dynamisch bestimmen (Mac + Handy)
    // ============================================================
    const BACKEND_PORT = "8000";
    const API_HOST = window.location.hostname || "localhost";
    const API_BASE = `http://${API_HOST}:${BACKEND_PORT}`;
    const API_URL = `${API_BASE}/classify`;

    console.log("Verwende Backend-URL:", API_URL);

    // ------------------------------------------------------------
    // DOM-Elemente
    // ------------------------------------------------------------
    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("preview");
    const previewPlaceholder = document.getElementById("previewPlaceholder");
    const sendBtn = document.getElementById("sendBtn");
    const statusEl = document.getElementById("status");
    const statusPill = document.getElementById("statusPill");
    const statusPillIcon = document.getElementById("statusPillIcon");
    const statusPillText = document.getElementById("statusPillText");

    const resultContainer = document.getElementById("resultContainer");
    const resultRaw = document.getElementById("resultRaw");
    const toggleRawBtn = document.getElementById("toggleRawBtn");

    const feedbackSection = document.getElementById("feedbackSection");
    const fbYes = document.getElementById("fbYes");
    const fbNo = document.getElementById("fbNo");
    const feedbackExtra = document.getElementById("feedbackExtra");
    const fbCorrectTaric = document.getElementById("fbCorrectTaric");
    const fbComment = document.getElementById("fbComment");
    const fbSave = document.getElementById("fbSave");
    const fbStatus = document.getElementById("fbStatus");

    let selectedFile = null;
    let lastResult = null;
    let rawVisible = false;
    let feedbackState = null; // 'yes' | 'no' | null

    function setStatusPill(mode, text) {
      statusPill.classList.remove("success", "error");
      if (mode === "idle") {
        statusPillIcon.textContent = "‚è∏";
      } else if (mode === "loading") {
        statusPillIcon.innerHTML = "";
        const spinner = document.createElement("div");
        spinner.className = "spinner";
        statusPillIcon.appendChild(spinner);
      } else if (mode === "success") {
        statusPill.classList.add("success");
        statusPillIcon.textContent = "‚úÖ";
      } else if (mode === "error") {
        statusPill.classList.add("error");
        statusPillIcon.textContent = "‚ö†Ô∏è";
      }
      statusPillText.textContent = text;
    }

    function clearFeedbackUI() {
      feedbackSection.style.display = "none";
      fbYes.classList.remove("active", "yes");
      fbNo.classList.remove("active", "no");
      feedbackExtra.classList.remove("visible");
      fbCorrectTaric.value = "";
      fbComment.value = "";
      fbStatus.textContent = "";
      feedbackState = null;
    }

    function renderResult(data) {
      lastResult = data;
      resultContainer.innerHTML = "";

      if (!data || !data.taric_code) {
        const div = document.createElement("div");
        div.className = "no-result";
        div.textContent = "Keine TARIC-Daten erhalten. Pr√ºfe Backend-Logs.";
        resultContainer.appendChild(div);
        clearFeedbackUI();
        return;
      }

      const taricCode = data.taric_code || "";
      const cnCode = data.cn_code || "";
      const hsChapter = data.hs_chapter || "";
      const confidence = typeof data.confidence === "number" ? data.confidence : parseFloat(data.confidence || "0");
      const shortReason = data.short_reason || "";
      const alternatives = Array.isArray(data.possible_alternatives) ? data.possible_alternatives : [];

      const wrapper = document.createElement("div");

      // Header mit TARIC und Confidence
      const header = document.createElement("div");
      header.className = "result-header";

      const taricBlock = document.createElement("div");
      taricBlock.className = "taric-main";

      const labelSpan = document.createElement("span");
      labelSpan.className = "taric-main-label";
      labelSpan.textContent = "TARIC";

      const codeSpan = document.createElement("span");
      codeSpan.textContent = taricCode;

      taricBlock.appendChild(labelSpan);
      taricBlock.appendChild(codeSpan);
      header.appendChild(taricBlock);

      const confDiv = document.createElement("div");
      confDiv.className = "confidence";
      const confPct = Math.round(Math.max(0, Math.min(1, confidence)) * 100);
      confDiv.textContent = `Confidence: ${isNaN(confPct) ? "-" : confPct + "%"}`;

      const bar = document.createElement("div");
      bar.className = "confidence-bar";
      const barInner = document.createElement("div");
      barInner.className = "confidence-bar-inner";
      barInner.style.width = `${isNaN(confPct) ? 0 : confPct}%`;
      bar.appendChild(barInner);

      const confWrap = document.createElement("div");
      confWrap.appendChild(confDiv);
      confWrap.appendChild(bar);

      header.appendChild(confWrap);

      wrapper.appendChild(header);

      // Codes (CN, HS)
      const codesGrid = document.createElement("div");
      codesGrid.className = "codes-grid";

      if (cnCode) {
        const pill = document.createElement("div");
        pill.className = "code-pill";
        pill.innerHTML = `<strong>CN-Code</strong> ${cnCode}`;
        codesGrid.appendChild(pill);
      }

      if (hsChapter) {
        const pill2 = document.createElement("div");
        pill2.className = "code-pill";
        pill2.innerHTML = `<strong>HS-Kapitel</strong> ${hsChapter}`;
        codesGrid.appendChild(pill2);
      }

      wrapper.appendChild(codesGrid);

      // Begr√ºndung
      if (shortReason) {
        const sr = document.createElement("div");
        sr.className = "short-reason";
        sr.innerHTML = `<strong>Begr√ºndung:</strong><br>${shortReason}`;
        wrapper.appendChild(sr);
      }

      // Alternativen
      const altDiv = document.createElement("div");
      altDiv.className = "alternatives";

      if (alternatives.length > 0) {
        const h3 = document.createElement("h3");
        h3.textContent = "M√∂gliche Alternativen";
        altDiv.appendChild(h3);

        const ul = document.createElement("ul");
        ul.className = "alt-list";

        for (const alt of alternatives) {
          const li = document.createElement("li");
          li.className = "alt-item";

          const code = document.createElement("div");
          code.className = "alt-item-code";
          code.textContent = alt.taric_code || "‚Äì";

          const reason = document.createElement("div");
          reason.className = "alt-item-reason";
          reason.textContent = alt.short_reason || "";

          li.appendChild(code);
          li.appendChild(reason);
          ul.appendChild(li);
        }

        altDiv.appendChild(ul);
      } else {
        const none = document.createElement("div");
        none.className = "no-result";
        none.textContent = "Keine Alternativcodes angegeben.";
        altDiv.appendChild(none);
      }

      wrapper.appendChild(altDiv);

      resultContainer.appendChild(wrapper);

      // Raw JSON aktualisieren
      resultRaw.textContent = JSON.stringify(data, null, 2);

      // Feedbackbereich aktivieren
      feedbackSection.style.display = "block";
      clearFeedbackUI(); // setzt intern alles zur√ºck, aber Section bleibt sichtbar
      feedbackSection.style.display = "block"; // wieder sichtbar machen
    }

    // Datei-Auswahl
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];

      if (!file) {
        selectedFile = null;
        preview.src = "";
        preview.style.display = "none";
        previewPlaceholder.style.display = "block";
        sendBtn.disabled = true;
        statusEl.textContent = "Bitte ein Bild ausw√§hlen.";
        setStatusPill("idle", "Warte auf Bild");
        return;
      }

      selectedFile = file;
      sendBtn.disabled = false;
      statusEl.textContent = "Bild gew√§hlt. Du kannst jetzt klassifizieren.";
      setStatusPill("idle", "Bereit zum Senden");

      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = "block";
        previewPlaceholder.style.display = "none";
      };
      reader.readAsDataURL(file);
    });

    // Bild senden
    sendBtn.addEventListener("click", async () => {
      if (!selectedFile) {
        statusEl.textContent = "Kein Bild ausgew√§hlt.";
        setStatusPill("error", "Kein Bild");
        return;
      }

      statusEl.textContent = "Sende Bild an Backend und warte auf Antwort‚Ä¶";
      setStatusPill("loading", "Klassifikation l√§uft‚Ä¶");
      sendBtn.disabled = true;
      rawVisible = false;
      resultRaw.style.display = "none";
      toggleRawBtn.textContent = "Rohes JSON anzeigen";
      clearFeedbackUI();
      resultContainer.innerHTML = `
        <div class="no-result">
          Modell wird aufgerufen, bitte warten‚Ä¶
        </div>
      `;

      const formData = new FormData();
      formData.append("file", selectedFile);

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          const errText = await response.text();
          statusEl.textContent = `Fehler vom Server (Status ${response.status}).`;
          setStatusPill("error", "Serverfehler");
          resultContainer.innerHTML = `
            <div class="no-result">
              Serverfehler beim Klassifizieren.<br>
              Details:<br>
              <code>${errText.replace(/</g, "&lt;")}</code>
            </div>
          `;
        } else {
          const data = await response.json();
          statusEl.textContent = "Ergebnis erfolgreich erhalten.";
          setStatusPill("success", "Ergebnis bereit");
          renderResult(data);
        }
      } catch (err) {
        console.error("Fetch-Fehler:", err);
        statusEl.textContent =
          "Netzwerkfehler: " + err.message +
          "\nPr√ºfe:\n- L√§uft das Backend auf Port 8000?\n- Bist du im selben WLAN wie der Server?\n- Stimmt die IP im Browser (Adresszeile)?";
        setStatusPill("error", "Netzwerkfehler");
        resultContainer.innerHTML = `
          <div class="no-result">
            Netzwerkfehler beim Aufruf von <code>${API_URL}</code>.<br>
            √ñffne die Browser-Konsole f√ºr Details.
          </div>
        `;
      } finally {
        sendBtn.disabled = false;
      }
    });

    // Rohes JSON ein-/ausblenden
    toggleRawBtn.addEventListener("click", () => {
      rawVisible = !rawVisible;
      resultRaw.style.display = rawVisible ? "block" : "none";
      toggleRawBtn.textContent = rawVisible ? "Rohes JSON ausblenden" : "Rohes JSON anzeigen";
    });

    // Feedback-Buttons
    fbYes.addEventListener("click", () => {
      feedbackState = "yes";
      fbYes.classList.add("active", "yes");
      fbNo.classList.remove("active", "no");
      feedbackExtra.classList.remove("visible");
      fbStatus.textContent = "Feedback: Vorschlag wird als korrekt markiert.";
    });

    fbNo.addEventListener("click", () => {
      feedbackState = "no";
      fbNo.classList.add("active", "no");
      fbYes.classList.remove("active", "yes");
      feedbackExtra.classList.add("visible");
      fbStatus.textContent = "Bitte korrigierten TARIC und optional Kommentar eintragen.";
    });

    // Feedback lokal speichern (localStorage)
    fbSave.addEventListener("click", () => {
      if (!lastResult) {
        fbStatus.textContent = "Kein Ergebnis vorhanden, das gespeichert werden k√∂nnte.";
        return;
      }

      if (feedbackState !== "no") {
        fbStatus.textContent = "Nur bei 'Nein, ist falsch' wird detailliertes Feedback gespeichert.";
        return;
      }

      const correctTaric = fbCorrectTaric.value.trim();
      const comment = fbComment.value.trim();

      if (!correctTaric && !comment) {
        fbStatus.textContent = "Bitte entweder einen korrekten TARIC oder einen Kommentar angeben.";
        return;
      }

      const entry = {
        timestamp: new Date().toISOString(),
        predicted_taric: lastResult.taric_code || null,
        predicted_cn: lastResult.cn_code || null,
        predicted_hs: lastResult.hs_chapter || null,
        confidence: lastResult.confidence ?? null,
        correct_taric: correctTaric || null,
        comment: comment || null,
        filename: selectedFile ? selectedFile.name : null,
      };

      let existing = [];
      try {
        const raw = localStorage.getItem("taric_feedback");
        if (raw) {
          existing = JSON.parse(raw);
        }
      } catch (e) {
        console.warn("Konnte vorhandenes Feedback nicht lesen:", e);
      }

      existing.push(entry);
      localStorage.setItem("taric_feedback", JSON.stringify(existing));

      fbStatus.textContent = "Feedback lokal gespeichert. (localStorage: 'taric_feedback')";
    });

    // Initialer Status
    setStatusPill("idle", "Warte auf Bild");
    statusEl.textContent = "Bitte ein Bild ausw√§hlen und dann klassifizieren.";
  </script>
</body>
</html>
